# nwjs-build.yml

# Workflow's name
name: Build SysMocap NW.js Version

# Workflow's trigger
on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Workflow's jobs
jobs:
  # Build NW.js version for desktop and mobile
  build-nwjs:
    name: Build NW.js Version
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: win
          - os: macos-latest
            platform: osx
    
    steps:
      # step1: check out repository
      - name: Check out git repository
        uses: actions/checkout@v4

      # step2: install node env
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # step3: npm install
      - name: Install dependencies
        run: |
          npm install

      # step4: build NW.js desktop packages
      - name: Build NW.js for ${{ matrix.platform }}
        shell: bash
        run: |
          set -e  # Exit on error
          mkdir -p ../OutApp/nw
          
          # Determine output directory name based on platform
          if [ "${{ matrix.platform }}" = "osx" ]; then
            BUILD_DIR="../OutApp/nw/SysMocap-osx-x64"
          elif [ "${{ matrix.platform }}" = "win" ]; then
            BUILD_DIR="../OutApp/nw/SysMocap-win-x64"
          else
            BUILD_DIR="../OutApp/nw/SysMocap-linux-x64"
          fi
          
          echo "Building for platform: ${{ matrix.platform }}"
          echo "Output directory: $BUILD_DIR"
          
          # Build with package.json as source (creates base package)
          # For macOS, add required macOS-specific arguments
          if [ "${{ matrix.platform }}" = "osx" ]; then
            npx nw-builder --mode=build --version=latest --flavor=normal --arch=x64 --platform=${{ matrix.platform }} --outDir="$BUILD_DIR" --app.LSApplicationCategoryType="public.app-category.graphics-design" --app.NSHumanReadableCopyright="Copyright Â© 2024 SysMocap Team" package.json
          else
            npx nw-builder --mode=build --version=latest --flavor=normal --arch=x64 --platform=${{ matrix.platform }} --outDir="$BUILD_DIR" package.json
          fi
          
          echo "NW.js build completed"
          echo "Checking build output..."
          ls -la "$BUILD_DIR" || echo "ERROR: BUILD_DIR not found!"
          ls -la "$BUILD_DIR/package.nw/" || echo "ERROR: package.nw not found!"
          
          # Copy all necessary files into the package
          echo "Copying application files..."
          cp -r node_modules "$BUILD_DIR/package.nw/"
          cp -r mainview "$BUILD_DIR/package.nw/"
          cp -r mocap "$BUILD_DIR/package.nw/"
          cp -r mocaprender "$BUILD_DIR/package.nw/"
          cp -r render "$BUILD_DIR/package.nw/"
          cp -r modelview "$BUILD_DIR/package.nw/"
          cp -r utils "$BUILD_DIR/package.nw/"
          cp -r models "$BUILD_DIR/package.nw/"
          cp -r fonts "$BUILD_DIR/package.nw/"
          cp -r icons "$BUILD_DIR/package.nw/"
          cp -r pdfs "$BUILD_DIR/package.nw/"
          cp -r pdfviewer "$BUILD_DIR/package.nw/"
          cp -r webserv "$BUILD_DIR/package.nw/" || true
          cp -r browser "$BUILD_DIR/package.nw/" || true
          cp *.js "$BUILD_DIR/package.nw/" || true
          
          echo "Files copied successfully"
          echo "Final package.nw contents:"
          ls -la "$BUILD_DIR/package.nw/" | head -20
        
      # step5: get version tag
      - name: Get version tag
        id: get_version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # step6: rename output directories
      - name: Rename build directories
        shell: bash
        run: |
          cd ../OutApp/nw
          for dir in */; do
            if [ -d "$dir" ]; then
              newname=$(echo "$dir" | sed "s/SysMocap/SysMocap-NWjs-${{ steps.get_version.outputs.VERSION }}/")
              mv "$dir" "$newname" || true
            fi
          done
          ls -la

      # step7: create archives
      - name: Create archives (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd ../OutApp/nw
          for dir in */; do
            if [ -d "$dir" ]; then
              tar -czf "${dir%/}.tar.gz" "$dir"
            fi
          done
          ls -la *.tar.gz || true

      - name: Create archives (Windows)
        if: runner.os == 'Windows'
        run: |
          cd ../OutApp/nw
          Get-ChildItem -Directory | ForEach-Object {
            Compress-Archive -Path $_.FullName -DestinationPath "$($_.Name).zip"
          }
          Get-ChildItem *.zip

      # step8: upload desktop artifacts
      - name: Upload NW.js desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SysMocap-NWjs-${{ matrix.platform }}-${{ steps.get_version.outputs.VERSION }}
          path: |
            ../OutApp/nw/*.tar.gz
            ../OutApp/nw/*.zip
          retention-days: 90

  # Build NW.js for Android
  build-nwjs-android:
    name: Build NW.js for Android
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow this job to fail without failing the workflow
    
    steps:
      # step1: check out repository
      - name: Check out git repository
        uses: actions/checkout@v4

      # step2: install node env
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # step3: setup Java for Android builds
      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # step4: setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # step5: npm install
      - name: Install dependencies
        run: |
          npm install

      # step6: install Cordova for mobile packaging
      - name: Install Cordova
        run: |
          npm install -g cordova

      # step7: create Cordova project for Android
      - name: Create Cordova Android project
        run: |
          mkdir -p mobile-build
          cd mobile-build
          cordova create sysmocap-android com.sysmocap.app SysMocap
          cd sysmocap-android
          cordova platform add android@latest
          
          # Copy application files
          cp -r ../../mainview www/
          cp -r ../../mocap www/
          cp -r ../../mocaprender www/
          cp -r ../../render www/
          cp -r ../../modelview www/
          cp -r ../../utils www/
          cp -r ../../models www/
          cp -r ../../fonts www/
          cp -r ../../icons www/
          cp -r ../../pdfs www/
          cp -r ../../pdfviewer www/
          
          # Copy necessary node_modules
          mkdir -p www/node_modules
          cp -r ../../node_modules/@mediapipe www/node_modules/
          cp -r ../../node_modules/@pixiv www/node_modules/
          cp -r ../../node_modules/@material www/node_modules/
          cp -r ../../node_modules/three www/node_modules/
          cp -r ../../node_modules/kalidokit www/node_modules/
          cp -r ../../node_modules/mdui www/node_modules/
          cp -r ../../node_modules/vue www/node_modules/
          cp -r ../../node_modules/lil-gui www/node_modules/
          
          # Create custom index.html that redirects to mainview
          cat > www/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
              <meta name="mobile-web-app-capable" content="yes">
              <title>SysMocap</title>
              <script>
                  window.location.href = 'mainview/framework.html';
              </script>
          </head>
          <body>
              <p>Loading SysMocap...</p>
          </body>
          </html>
          EOF
          
          # Update config.xml for camera permissions
          cat > config.xml << 'EOF'
          <?xml version='1.0' encoding='utf-8'?>
          <widget id="com.sysmocap.app" version="0.7.3" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0" xmlns:android="http://schemas.android.com/apk/res/android">
              <name>SysMocap</name>
              <description>Video-based motion capture system for Android</description>
              <author email="dev@sysmocap.com" href="https://github.com/xianfei/SysMocap">
                  SysMocap Team
              </author>
              <content src="index.html" />
              <access origin="*" />
              <allow-intent href="http://*/*" />
              <allow-intent href="https://*/*" />
              <allow-navigation href="*" />
              <preference name="DisallowOverscroll" value="true" />
              <preference name="android-minSdkVersion" value="24" />
              <preference name="android-targetSdkVersion" value="34" />
              <preference name="android-compileSdkVersion" value="35" />
              <preference name="Fullscreen" value="false" />
              <preference name="Orientation" value="default" />
              <platform name="android">
                  <allow-intent href="market:*" />
                  <preference name="AndroidXEnabled" value="true" />
                  <preference name="GradlePluginKotlinEnabled" value="true" />
                  <preference name="GradlePluginKotlinCodeStyle" value="official" />
                  <preference name="GradlePluginKotlinVersion" value="1.9.0" />
                  <config-file parent="/*" target="AndroidManifest.xml">
                      <uses-permission android:name="android.permission.CAMERA" />
                      <uses-permission android:name="android.permission.RECORD_AUDIO" />
                      <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
                      <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
                      <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
                      <uses-permission android:name="android.permission.INTERNET" />
                      <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
                      <uses-feature android:name="android.hardware.camera" android:required="true" />
                      <uses-feature android:name="android.hardware.camera.autofocus" />
                  </config-file>
                  <config-file parent="/*" target="res/xml/network_security_config.xml">
                      <network-security-config>
                          <base-config cleartextTrafficPermitted="true">
                              <trust-anchors>
                                  <certificates src="system" />
                              </trust-anchors>
                          </base-config>
                      </network-security-config>
                  </config-file>
              </platform>
          </widget>
          EOF

      # step8: build Android APK
      - name: Build Android APK
        run: |
          cd mobile-build/sysmocap-android
          echo "Building Android APK (debug mode)..."
          cordova build android --verbose || {
            echo "Build failed. Checking for error logs..."
            find platforms/android -name "*.log" -exec cat {} \;
            exit 1
          }
          
          # Find and list the APK
          echo "Looking for built APK files..."
          find platforms/android/app/build/outputs/apk -name "*.apk" -ls

      # step9: get version tag
      - name: Get version tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # step10: rename APK
      - name: Rename and copy APK
        run: |
          mkdir -p android-build
          # Find debug APK (since we're not signing for release)
          APK_FILE=$(find mobile-build/sysmocap-android/platforms/android/app/build/outputs/apk -name "*-debug.apk" | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "Error: No APK file found"
            find mobile-build/sysmocap-android/platforms/android/app/build/outputs/apk -type f
            exit 1
          fi
          cp "$APK_FILE" android-build/SysMocap-Android-${{ steps.get_version.outputs.VERSION }}.apk
          echo "APK copied successfully"
          ls -lh android-build/

      # step11: upload Android artifacts
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: SysMocap-Android-${{ steps.get_version.outputs.VERSION }}
          path: android-build/*.apk
          retention-days: 90

      # step12: create build summary
      - name: Create build summary
        run: |
          echo "## ðŸ“± Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Android" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: Cordova" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh android-build/*.apk | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download APK from artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Install on Android device" >> $GITHUB_STEP_SUMMARY
          echo "3. Grant camera permissions" >> $GITHUB_STEP_SUMMARY
          echo "4. Launch SysMocap" >> $GITHUB_STEP_SUMMARY

  # Create release with all artifacts
  create-release:
    name: Create Release
    needs: [build-nwjs]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Get version tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          body: |
            ## SysMocap NW.js Release ${{ steps.get_version.outputs.VERSION }}
            
            This release includes NW.js builds for desktop and mobile platforms.
            
            ### Desktop Downloads
            - **Linux**: `SysMocap-NWjs-*-linux-*.tar.gz`
            - **Windows**: `SysMocap-NWjs-*-windows-*.zip`
            - **macOS**: `SysMocap-NWjs-*-osx-*.tar.gz`
            
            ### Mobile Downloads
            - **Android**: `SysMocap-Android-*.apk`
            
            ### Installation
            
            **Desktop:**
            1. Download the appropriate archive for your OS
            2. Extract the archive
            3. Run the SysMocap executable
            
            **Android:**
            1. Download the APK file
            2. Enable "Install from unknown sources" in Android settings
            3. Install the APK
            4. Grant camera and storage permissions when prompted
            5. Launch SysMocap
            
            ### Features
            - âœ… Desktop support (Windows, macOS, Linux)
            - âœ… Android mobile support
            - âœ… Full motion capture capabilities
            - âœ… Native performance
            - âœ… Smaller package size than Electron (~30% reduction)
            
            ### System Requirements
            
            **Desktop:**
            - Modern 64-bit processor
            - 4GB RAM minimum, 8GB recommended
            - Graphics card with WebGL support
            
            **Android:**
            - Android 7.0 (API 24) or higher
            - Camera with at least 720p resolution
            - 2GB RAM minimum
            
            See [RUNTIME_MODES.md](../blob/main/RUNTIME_MODES.md) for detailed documentation.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
